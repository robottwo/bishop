name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read
  id-token: write

jobs:
  claude-review:
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@claude'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Wait for CI workflows to complete
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head_sha = context.payload.pull_request.head.sha;
            const requiredWorkflows = ['CI', 'Lint', 'Vulnerability Check'];

            const maxAttempts = 60;  // 30 minutes max wait (60 * 30s)
            const pollInterval = 30000;  // 30 seconds

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              console.log(`Attempt ${attempt}/${maxAttempts}: Checking workflow status...`);

              // Get all check runs for this commit
              const { data: checkRuns } = await github.rest.checks.listForRef({
                owner,
                repo,
                ref: head_sha,
              });

              // Find the status of required workflows
              const workflowStatus = {};
              for (const workflow of requiredWorkflows) {
                const matchingRuns = checkRuns.check_runs.filter(run =>
                  run.name.includes(workflow) ||
                  checkRuns.check_runs.some(r => r.app?.name === 'GitHub Actions' && r.name.includes(workflow))
                );

                if (matchingRuns.length === 0) {
                  workflowStatus[workflow] = 'pending';
                } else {
                  // Check if all matching runs are complete and successful
                  const allComplete = matchingRuns.every(run => run.status === 'completed');
                  const allSuccess = matchingRuns.every(run => run.conclusion === 'success');

                  if (!allComplete) {
                    workflowStatus[workflow] = 'in_progress';
                  } else if (allSuccess) {
                    workflowStatus[workflow] = 'success';
                  } else {
                    workflowStatus[workflow] = 'failure';
                  }
                }
              }

              console.log('Workflow status:', JSON.stringify(workflowStatus, null, 2));

              // Check if any workflow failed
              const failed = Object.entries(workflowStatus).filter(([_, status]) => status === 'failure');
              if (failed.length > 0) {
                core.setFailed(`CI workflows failed: ${failed.map(([name]) => name).join(', ')}. Skipping Claude review to save tokens.`);
                return;
              }

              // Check if all workflows succeeded
              const allSucceeded = Object.values(workflowStatus).every(status => status === 'success');
              if (allSucceeded) {
                console.log('All CI workflows passed! Proceeding with Claude review.');
                return;
              }

              // Still waiting
              console.log(`Waiting ${pollInterval/1000}s before next check...`);
              await new Promise(resolve => setTimeout(resolve, pollInterval));
            }

            core.setFailed('Timeout waiting for CI workflows to complete');

      - name: Run Claude Code Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "@claude"

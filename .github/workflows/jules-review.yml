name: Jules Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  actions: read

jobs:
  jules-review:
    # Trigger on PR events or when @jules is mentioned in a PR comment
    if: |
      (github.event_name == 'pull_request') ||
      (github.event_name == 'issue_comment' &&
       github.event.issue.pull_request &&
       contains(github.event.comment.body, '@jules'))
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Wait for CI workflows to complete
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head_sha = context.payload.pull_request.head.sha;

            // Map workflow file names to display names
            const requiredWorkflows = [
              { file: 'ci.yml', name: 'CI' },
              { file: 'lint.yml', name: 'Lint' },
              { file: 'govulncheck.yml', name: 'Vulnerability Check' }
            ];

            const maxAttempts = 60;  // 30 minutes max wait (60 * 30s)
            const pollInterval = 30000;  // 30 seconds

            for (let attempt = 1; attempt <= maxAttempts; attempt++) {
              console.log(`Attempt ${attempt}/${maxAttempts}: Checking workflow status...`);

              // Get all workflow runs for this commit
              const { data: workflowRuns } = await github.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                head_sha,
                per_page: 100,
              });

              // Find the status of required workflows
              const workflowStatus = {};
              for (const workflow of requiredWorkflows) {
                // Find runs matching this workflow file
                const matchingRuns = workflowRuns.workflow_runs.filter(run =>
                  run.path === `.github/workflows/${workflow.file}`
                );

                if (matchingRuns.length === 0) {
                  workflowStatus[workflow.name] = 'pending';
                } else {
                  // Get the most recent run for this workflow
                  const latestRun = matchingRuns.sort((a, b) =>
                    new Date(b.created_at) - new Date(a.created_at)
                  )[0];

                  if (latestRun.status !== 'completed') {
                    workflowStatus[workflow.name] = 'in_progress';
                  } else if (latestRun.conclusion === 'success') {
                    workflowStatus[workflow.name] = 'success';
                  } else {
                    workflowStatus[workflow.name] = 'failure';
                  }
                }
              }

              console.log('Workflow status:', JSON.stringify(workflowStatus, null, 2));

              // Check if any workflow failed
              const failed = Object.entries(workflowStatus).filter(([_, status]) => status === 'failure');
              if (failed.length > 0) {
                core.setFailed(`CI workflows failed: ${failed.map(([name]) => name).join(', ')}. Skipping Jules review to save tokens.`);
                return;
              }

              // Check if all workflows succeeded
              const allSucceeded = Object.values(workflowStatus).every(status => status === 'success');
              if (allSucceeded) {
                console.log('All CI workflows passed! Proceeding with Jules review.');
                return;
              }

              // Still waiting
              console.log(`Waiting ${pollInterval/1000}s before next check...`);
              await new Promise(resolve => setTimeout(resolve, pollInterval));
            }

            core.setFailed('Timeout waiting for CI workflows to complete');

      - name: Get PR details
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber, prTitle, prBody, baseBranch, headBranch;

            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
              prTitle = context.payload.pull_request.title;
              prBody = context.payload.pull_request.body || '';
              baseBranch = context.payload.pull_request.base.ref;
              headBranch = context.payload.pull_request.head.ref;
            } else {
              // For issue_comment event, get PR details
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.issue.number
              });
              prNumber = pr.number;
              prTitle = pr.title;
              prBody = pr.body || '';
              baseBranch = pr.base.ref;
              headBranch = pr.head.ref;
            }

            core.setOutput('pr_number', prNumber);
            core.setOutput('pr_title', prTitle);
            core.setOutput('pr_body', prBody);
            core.setOutput('base_branch', baseBranch);
            core.setOutput('head_branch', headBranch);

      - name: Get changed files
        id: changed-files
        run: |
          git fetch origin ${{ steps.pr-details.outputs.base_branch }}
          FILES=$(git diff --name-only origin/${{ steps.pr-details.outputs.base_branch }}...HEAD)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      # Use official Jules GitHub Action for code review
      # Documentation: https://github.com/google-labs-code/jules-action
      - name: Run Jules Code Review
        uses: google-labs-code/jules-action@v1.0.0
        with:
          jules_api_key: ${{ secrets.JULES_API_KEY }}
          prompt: |
            Please review this pull request and provide detailed feedback.

            ## PR Information
            - **Title**: ${{ steps.pr-details.outputs.pr_title }}
            - **Branch**: ${{ steps.pr-details.outputs.head_branch }} â†’ ${{ steps.pr-details.outputs.base_branch }}
            - **Description**: ${{ steps.pr-details.outputs.pr_body }}

            ## Changed Files
            ${{ steps.changed-files.outputs.files }}

            ## Review Guidelines
            Please analyze the changes and provide feedback on:

            1. **Code Quality**: Are there any code smells, anti-patterns, or violations of best practices?
            2. **Bugs & Logic Errors**: Are there any potential bugs, edge cases, or logic errors?
            3. **Security**: Are there any security vulnerabilities (injection, XSS, hardcoded secrets, etc.)?
            4. **Performance**: Are there any performance concerns or optimization opportunities?
            5. **Maintainability**: Is the code readable, well-documented, and easy to maintain?
            6. **Testing**: Are there adequate tests? Are there any untested edge cases?

            Please be constructive and specific in your feedback. If everything looks good, say so!

            After your review, please post a summary comment on the pull request.
